<!DOCTYPE html>
<!--[if lt IE 9]>
<script src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/html5shiv.js"></script>
<script src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/respond.min.js"></script>
<![endif]-->
<meta charset="utf-8">
<html lang="en">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Web Analytics KPI</title>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="http://d3js.org/topojson.v1.js"></script>

    <link href="http://ivanyinusa.github.io/WebAnalyticsKPI/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://ivanyinusa.github.io/WebAnalyticsKPI/css/bootstrap-switch.min.css" rel="stylesheet">
    <link href="http://ivanyinusa.github.io/WebAnalyticsKPI/css/bootstrap-table.min.css" rel="stylesheet">
    <link href="http://ivanyinusa.github.io/WebAnalyticsKPI/css/styles.css" rel="stylesheet">
    <link href="http://ivanyinusa.github.io/WebAnalyticsKPI/css/nv.d3.css" rel="stylesheet" type="text/css">
    <link href="dojo.css" data-dojo-config="async: true">
    <link rel="stylesheet" type="text/css" href="http://ivanyinusa.github.io/WebAnalyticsKPI/css/base.css" />

    <script type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/prototype.js" ></script>
    <script language="javascript" type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/d3.v3.min.js"></script>
    <script language="javascript" type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/dojo.js"></script>
    <script language="javascript" type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/nv.d3.js"></script>
    <script language="javascript" type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/i_ui_gauge.js"></script>
    <script language="javascript" type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/i_ui_digit.js"></script>
    <script language="javascript" type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/i_ui_gis.js"></script>

    <script language="javascript" type="text/javascript">
        var monthNames = [
            "Jan", "Feb", "Mar",
            "Apr", "May", "Jun", "Jul",
            "Aug", "Sep", "Oct",
            "Nov", "Dec"
        ];
    </script>
    <script language="javascript" type="text/javascript">

        function control_tr(tr, button) {
            var button_style = $(button).className;
            if (button_style == 'plusIcon') {
                $(button).className = 'minusIcon';
                if (tr == "inc") {
                    $("incex").style.display = 'table-row';
                    $("increc").style.display = 'table-row';
                }
                if (tr == "b2b") {
                    $("smb").style.display = 'table-row';
                    $("wholesale").style.display = 'table-row';
                }
                if (tr == "ebay") {
                    $("ebayusa").style.display = 'table-row';
                    $("ebaycan").style.display = 'table-row';
                }
                if (tr == "mkt") {
                    $("mktb2b").style.display = 'table-row';
                    $("mktusa").style.display = 'table-row';
                    $("mktcan").style.display = 'table-row';
                }
                if (tr == "3rd") {
                    $("ebay").style.display = 'table-row';
                    $("jet").style.display = 'table-row';
                }
                if (tr == "international") {
                    $("intaus").style.display = 'table-row';
                    $("intgbr").style.display = 'table-row';
                    $("intind").style.display = 'table-row';
                    $("intirl").style.display = 'table-row';
                    $("intnld").style.display = 'table-row';
                    $("intnzl").style.display = 'table-row';
                    $("intpol").style.display = 'table-row';
                    $("intsgp").style.display = 'table-row';
                }
            }
            else if (button_style == 'minusIcon') {
                $(button).className = 'plusIcon';
                if (tr == "inc") {
                    $("incex").style.display = 'none';
                    $("increc").style.display = 'none';
                }
                if (tr == "b2b") {
                    $("smb").style.display = 'none';
                    $("wholesale").style.display = 'none';
                }
                if (tr == "ebay") {
                    $("ebayusa").style.display = 'none';
                    $("ebaycan").style.display = 'none';
                }
                if (tr == "mkt") {
                    $("mktb2b").style.display = 'none';
                    $("mktusa").style.display = 'none';
                    $("mktcan").style.display = 'none';
                }
                if (tr == "3rd") {
                    if ($("button_ebay").className == 'minusIcon') control_tr("ebay", "button_ebay");
                    $("ebay").style.display = 'none';
                    $("jet").style.display = 'none';
                }
                if (tr == "international") {
                    $("intaus").style.display = 'none';
                    $("intgbr").style.display = 'none';
                    $("intind").style.display = 'none';
                    $("intirl").style.display = 'none';
                    $("intnld").style.display = 'none';
                    $("intnzl").style.display = 'none';
                    $("intpol").style.display = 'none';
                    $("intsgp").style.display = 'none';
                }
            }
        }

        var valueOfTopN = 0;
        var valueOfSortBy = "County";
        var valueOfFilter = "";
        var pagetag = "info:client:page=dashboard";
        var gis_data = null;
        var dojoJSON;
        var digit = new i_ui_digit();
        var ws;
        require(["dojo/currency", "dojo/number", "dojo/store/Memory", "dojo/json", "dojo/domReady!"],
                function(Currency, Number, Memory, JSON) {
                    cMemory = Memory;
                    dojoJSON = JSON;
                    digit.dashboard_report();
                    if ($("button_inc")) $("button_inc").addEventListener("click", function() { control_tr("inc", "button_inc") });
                    if ($("button_b2b")) $("button_b2b").addEventListener("click", function() { control_tr("b2b", "button_b2b") });
                    if ($("button_ebay")) $("button_ebay").addEventListener("click", function() { control_tr("ebay", "button_ebay") });
                    if ($("button_mkt")) $("button_mkt").addEventListener("click", function() { control_tr("mkt", "button_mkt") });
                    if ($("button_3rd")) $("button_3rd").addEventListener("click", function() { control_tr("3rd", "button_3rd") });
                    if ($("button_international")) $("button_international").addEventListener("click", function() { control_tr("international", "button_international") });
                    control_tr("inc", "button_inc");
                    control_tr("b2b", "button_b2b");
                    control_tr("mkt", "button_mkt");

                    function BUShare() {
                        var sales = {
                            inc: $("table_gps_inc").innerHTML.split("$")[1].replace(/,/g, ""),
                            usa: $("table_gps_usa").innerHTML.split("$")[1].replace(/,/g, ""),
                            b2b: $("table_gps_b2b").innerHTML.split("$")[1].replace(/,/g, ""),
                            can: $("table_gps_can").innerHTML.split("$")[1].replace(/,/g, ""),
                            ebay: $("table_gps_3rd").innerHTML.split("$")[1].replace(/,/g, ""),
                            mp: $("table_gps_mkt").innerHTML.split("$")[1].replace(/,/g, ""),
                            international: $("table_gps_international").innerHTML.split("$")[1].replace(/,/g, "")
                        }
                        var total = parseFloat(sales.inc) + parseFloat(sales.mp);
                        $("table_share_inc").innerHTML = this.digit.replace_minus_sign(sales.inc / total);
                        $("table_share_mkt").innerHTML = this.digit.replace_minus_sign(sales.mp / total);
                        $("table_share_usa").innerHTML = this.digit.replace_minus_sign((sales.usa / sales.inc) * (sales.inc / total));
                        $("table_share_b2b").innerHTML = this.digit.replace_minus_sign((sales.b2b / sales.inc) * (sales.inc / total));
                        $("table_share_can").innerHTML = this.digit.replace_minus_sign((sales.can / sales.inc) * (sales.inc / total));
                        $("table_share_b2b").innerHTML = this.digit.replace_minus_sign((sales.b2b / sales.inc) * (sales.inc / total));
                        $("table_share_3rd").innerHTML = this.digit.replace_minus_sign((sales.ebay / sales.inc) * (sales.inc / total));
                        $("table_share_international").innerHTML = this.digit.replace_minus_sign((sales.international / sales.inc) * (sales.inc / total));
                    }



                    function printBU(bu, elem) {
                        var gps = $("table_gps_" + bu);
                        var ds = $("table_ds_" + bu);
                        var gpm = $("table_gpm_" + bu);
                        var gpmr = $("table_gpmr_" + bu);
                        var eims = $("table_eims_" + bu);
                        var drafteims = $("table_drafteims_" + bu);
                        var pmwitheims = $("table_pmwitheims_" + bu);
                        var pmwitheimsr = $("table_pmwitheimsr_" + bu);
                        var quantity = $("table_quantity_" + bu);
                        var orders = $("table_orders_" + bu);
                        var shipping = $("table_shipping_" + bu);
                        var voidgps = $("table_voidgps_" + bu);
                        var voidquantity = $("table_voidquantity_" + bu);
                        var voidorders = $("table_voidorders_" + bu);

                        if (gps) gps.innerHTML = this.digit.money(elem.soamount);
                        if (ds) {
                            ds.innerHTML = this.digit.money(elem.discount);
                            ds.className = ((elem.discount >= 0) ? "number_2" : "number_3");
                        }
                        if (gpm) {
                            gpm.innerHTML = this.digit.money(elem.grossproductmargin);
                            gpm.className = ((elem.grossproductmargin >= 0) ? "number_2" : "number_3");
                        }
                        if (gpmr) {
                            var ratio = elem.grossproductmargin / elem.soamount;
                            gpmr.innerHTML = this.digit.replace_minus_sign(ratio);
                            gpmr.className = ((ratio >= 0) ? "number_2" : "number_3");
                        }
                        if (eims) {
                            eims.innerHTML = this.digit.money(elem.eims);
                            eims.className = ((elem.eims >= 0) ? "number_2" : "number_3");
                        }
                        if (drafteims) {
                            drafteims.innerHTML = this.digit.money(elem.drafteims);
                            drafteims.className = ((elem.drafteims >= 0) ? "number_2" : "number_3");
                        }
                        if (pmwitheims) {
                            pmwitheims.innerHTML = this.digit.money(elem.grossproductmargin + elem.eims + elem.drafteims);
                            pmwitheims.className = (((elem.grossproductmargin + elem.eims + elem.drafteims) >= 0) ? "number_2" : "number_3");
                        }
                        if (pmwitheimsr) {
                            var ratio = (elem.grossproductmargin + elem.eims+elem.drafteims) / elem.soamount;
                            pmwitheimsr.innerHTML = this.digit.replace_minus_sign(ratio);
                            pmwitheimsr.className = ((ratio >= 0) ? "number_2" : "number_3");
                        }
                        if (quantity) quantity.innerHTML = Number.format(elem.quantity);
                        if (orders) orders.innerHTML = Number.format(elem.orders);
                        if (shipping) shipping.innerHTML = this.digit.money(elem.shippingcharge);
                        if (voidgps) voidgps.innerHTML = this.digit.money(elem.ex_soamount);
                        if (voidquantity) voidquantity.innerHTML = Number.format(elem.ex_quantity);
                        if (voidorders) voidorders.innerHTML = Number.format(elem.ex_orders);

                    }

                    function updateTimeStamp(dt) {
                        if (!dt) dt = new Date();
                        var hours = ((dt.getHours() + 11) % 12 + 1);
                        var minutes = dt.getMinutes();
                        var h = (hours < 10) ? ("0" + hours.toString()) : hours.toString()
                        var m = (minutes < 10) ? ("0" + minutes.toString()) : minutes.toString()
                        h = (h == "00") ? 12 : h;
                        if ($("div_ts_tiempo")) $("div_ts_tiempo").innerHTML = h + ":" + m;
                        if ($("div_ts_sufix")) $("div_ts_sufix").innerHTML = (dt.getHours() >= 12) ? "PM" : "AM";
                    }

                    updateTimeStamp();
                    ws = new i_ui_websocket({
                        arg: {
                            host: "10.1.54.8",
                            port: "8080",
                            channel: "so_bybu"
                        },
                        gauge_cdc: {
                            id: "g_cdc",
                            label: "Source"
                        },
                        gauge_spark: {
                            id: "g_spark",
                            label: "Spark"
                        },
                        gauge_socket: {
                            id: "g_socket",
                            label: "Socket"
                        },
                        gauge_d3: {
                            id: "g_d3",
                            label: "D3js"
                        },
                        push_date: function(dt) {
                            $("div_ts_day").innerHTML = monthNames[dt.getMonth()] + " " + dt.getDate() + ", " + dt.getFullYear().toString();
                        },
                        push_time: function(dt) {
                            if ($("lbl_proc_time")) $("lbl_proc_time").innerHTML = dt;
                            updateTimeStamp(new Date(dt));
                        },
                        push_kpi: function(elem) {
                            printBU(elem.bu, elem);
                            BUShare();
                        },
                        push_gis: function(data) {
                            if (!data) data = gis_data;
                            if (!data) return;
                            var map = $("if_mapstate");
                            if (map) {
                                if (map.contentWindow) {
                                    map.contentWindow.gis_data = data;
                                    map.contentWindow.gis.on_gisdata(data);
                                }
                            }
                        },
                        lbl_proc_time: $("lbl_proc_time"),
                        lbl_proc_socket: $("lbl_proc_socket"),
                        div_spark_logo_activate: $("div_spark_logo_activate"),
                        div_spark_logo_deactivate: $("div_spark_logo_deactivate"),
                        tbl_bu_sales: $("tbl_bu_sales")
                    });
                });
    </script>

    <style>
        h2 {
            margin: 12px;
        }
        .heading {
            font-weight: bold;
            padding-bottom: 0.25em;
        }
        /* also not part of theme, but a contrived example of using dgrid-sortable. */
        .dgrid-sortable {
            font-weight: bold;
        }
        /* add styles to size this grid appropriately */
        .dgrid-autoheight {
            height: 20em;
            margin: 2em;
            font: 4px sans-serif;
            font-size: 2em;
        }
        #scrollgrid {
            width: 700px;
            zoom: 1;
        }
        #scrollgrid .dgrid-cell {
            width: 100px; /* force all columns to have SOME width */
        }
        #scrollgrid .field-col1 {
            width: 500px;
        }
        #scrollgrid .field-col4 {
            width: 300px;
        }
        .navbar-brand {
            width: auto;
            padding: 15px;
        }
        .navbar-brand>img {
            max-height: 100%;
            height: 100%;
            width: auto;
            -o-object-fit: contain;
            object-fit: contain;
            padding: 0px; /* firefox bug fix */
        }
        .navbar-inner {
            background:transparent;
        }
        label{
            width:150px;
            float:left;
        }
        .grid{
            border:2px solid #333;
            height: 100%;
            width: 100%;
            margin:0px;
            padding:500px;
        }
        .dgrid-no-data,
        .dgrid-loading {
            color: #aaa;
            font-size: 3em;
            padding: 3em;
            text-align: center;
        }
        body {
            font: 10px sans-serif;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .x.axis path {
            display: none;
        }
        text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        html, body, #chart1, svg {
            margin: 0px;
            padding: 10px;
            height: 100%;
            width: 100%;
            max-width: 100%;
            max-height: 90%;
        }
        .nv-bars rect {
            width: 20px;
        }
        .Aligner {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .Aligner-item {
            max-width: 60%;
        }
        .d3-tip {
            line-height: 1;
            font-weight: bold;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 2px;
        }
        /* Creates a small triangle extender for the tooltip */
        .d3-tip:after {
            box-sizing: border-box;
            display: inline;
            font-size: 10px;
            width: 100%;
            line-height: 1;
            color: rgba(0, 0, 0, 0.8);
            content: "\25BC";
            position: absolute;
            text-align: center;
        }
        /* Style northward tooltips differently */
        .d3-tip.n:after {
            margin: -1px 0 0 0;
            top: 100%;
            left: 0;
        }
    </style>
</head>
<body class="tundra">
<script src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/d3.v3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/d3.v3.js"></script>
<script type="text/javascript" src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/d3.tip.v0.6.3.js"></script>
<link href="http://ivanyinusa.github.io/WebAnalyticsKPI/css/nv.d3.min.css" rel="stylesheet">
<script src="http://ivanyinusa.github.io/WebAnalyticsKPI/js/nv.d3.min.js"></script>

<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container-fluid">
        <div class="navbar-header">
            <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">

                <img src="http://ivanyinusa.github.io/WebAnalyticsKPI/images/dashboard_lightblue_trans.png" style="width:60px;float:left;" />

                <a class="nav navbar-brand" href="#">Web Analytics KPI</a>
                <a class="nav navbar-brand navbar-inner" href="https://github.com/ivanyinusa"><img src="http://ivanyinusa.github.io/WebAnalyticsKPI/Penguin_4.ico"></a>
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar4">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <ul class="nav navbar-nav navbar-left container-fluid">
                    <li class="active"><a href="ivanyinusa.github.io/WebAnalyticsKPI">Home</a></li>
                    <li><a href="/WebAnalyticsKPI/test">Test</a></li>
                    <li><a href="/WebAnalyticsKPI/debug">Debug</a></li>
                    <li><a href="/WebAnalyticsKPI/google">Google</a></li>
                    <li><a href="/WebAnalyticsKPI/dashboard">Dashboard</a></li>
                    <li><a href="/WebAnalyticsKPI/contact">Contact</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Dropdown <span class="caret"></span></a>
                        <ul class="dropdown-menu" role="menu">
                            <li><a href="http://www.google.com">Proxy Google</a></li>
                            <li><a href="#">Another action</a></li>
                            <li><a href="#">Something else here</a></li>
                            <li class="divider"></li>
                            <li class="dropdown-header">Nav header</li>
                            <li><a href="#">Separated link</a></li>
                            <li><a href="#">One more separated link</a></li>
                        </ul>
                    </li>
                    <li><a href="#">About</a></li>
                </ul>

                <ul class="nav navbar-nav navbar-right container-fluid">

                    <!--<img src="http://ivanyinusa.github.io/WebAnalyticsKPI/images/spark-logo-black-color.png" alt="spark" style=""/>-->
                    <div id="div_spark_logo_activate" class="spark_logo_activate"></div>
                    <div id="div_spark_logo_deactivate" class="spark_logo_deactivate"></div>
                    <div id="g_d3" style="float:right;"></div>
                    <div id="g_socket" style="float:right;"></div>
                    <div id="g_spark" style="float:right;"></div>
                    <div id="g_cdc" style="float:right;"></div>

                    <li><a href="#"><span class="glyphicon glyphicon-user"></span> Sign Up</a></li>
                    <li><a href="#"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
                </ul>

            </div>
        </div>
    </div>
</nav>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>

<div id = "mapcounty"></div>

<script>

    var width = 500;
    var height = 260;
    var ls_w = 20;
    var ls_h = 20;
    var initialized = 0;
    var scale_width = 460;
    var map_instance = d3.map();
    init_map();
    get_map_json();

    function init_map() {

        var range = [0, 270000];
        this.scale_for_map = d3.scale.ordinal()
                .domain(d3.range(9))
                .rangeBands([range[0], range[1]]).range();

        this.scale_for_legend = d3.scale.ordinal()   //scale for legend
                .domain(d3.range(9))
                .rangeBands([range[1], range[0]]).range();

        this.gis_color = d3.scale.threshold()
                .domain(this.scale_for_map)
                .range(d3.range(12).map(function(i) { return "q" + i.toString() + "-13"; }));

        var projection = d3.geo.albersUsa()
                .scale(this.scale_width)
                .translate([(this.width * 0.45), (this.height * 0.50)]);

        this.path = d3.geo.path()
                .projection(projection);

        this.gis_tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([6, 0])
                .html(function(d, i) {
                    return "<b>State:</b>" + d.properties.name
                            + "<br>Revenue:loading....";
                });

        this.svg = d3.selectAll("#mapcounty").append("svg")
                .attr("width", this.width)
                .attr("height", this.height)
                .call(this.gis_tip);

        this.g_background = this.svg.append("g");
        this.g_background.append("rect")
                .attr("class", "background")
                .attr("width", this.width)
                .attr("height", this.height);
    };

    function get_map_json() {
        dojo.xhrGet({
            url: "us-states.json",
            handleAs: "json",
            load: dojo.hitch(this, this.draw_map)
        });
    };

    function to_county() {
        document.location.href = "gis/index.html";
    };

    function draw_map(us) {
        var ls_h = this.ls_h;
        var height = this.height;
        var gis_color = this.gis_color;

        this.map_counties = this.g_background.append("g")
                .attr("id", "counties")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.states).features)
                .enter().append("path")
                .attr("d", this.path)
                .style("cursor", "hand")
                .on('mouseover', this.gis_tip.show)
                .on('mouseout', this.gis_tip.hide)
                .on('click', this.to_county)
                .attr('fill', 'white');

        var labelStartCoodinates = [510, 130];
        var path = this.path;
        var g_back = this.g_background;
        this.g_background.selectAll("shortnameview")
                .data(topojson.feature(us, us.objects.states).features)
                .enter()
                .append("g")
                .attr("draw-shortname", function(d) {
                    var center = path.centroid(d);
                    if (isNaN(center[0])) return;
                    var xOffset = 7.5, yOffset = 5;

                    if (["FL", "KY", "MI"].indexOf(d.properties.state) > -1) xOffset = -2.5;
                    if (d.properties.state === "NY") {
                        xOffset = 6;
                        yOffset = 1;
                    }
                    if (d.properties.state === "MI") yOffset = 18;
                    if (d.properties.state === "LA") xOffset = 13;

                    var x = 0;
                    var y = 0;

                    x = center[0] - xOffset;
                    y = center[1] + yOffset;
                    var yStart = labelStartCoodinates[1];

                    var smallStateIndex = ["VT", "NH", "MA", "RI", "CT", "NJ", "DE", "MD", "DC"].indexOf(d.properties.state);
                    if (smallStateIndex > -1) {
                        x = labelStartCoodinates[0] - 100;
                        y = yStart + (smallStateIndex * (2 + 12)) - 60;
                        g_back.append("line")
                                .attr("x1", x - 3)
                                .attr("y1", y - 5)
                                .attr("x2", center[0])
                                .attr("y2", center[1])
                                .style("stroke", "#000")
                                .style("stroke-width", 1);
                    }
                    //  if (x = "NaN") { console.log(d.properties.state) }

                    g_back.append("text")
                            .attr("x", x)
                            .attr("y", y)
                            .style("font-size", '10px')
                            .style("font-family", "Verdana")
                            .style("fill", "#000")
                            .style("pointer-events", "none")
                            .text(d.properties.state);

                });


        this.legend = this.svg.selectAll("g.legend")
                .data(this.scale_for_legend)
                .enter().append("g")
                .attr("class", "legend");

        this.legendimage = this.legend.append("rect")
                .attr("x", 0)
                .attr("y", function(d, i) { return ((i + 1) * ls_h); })
                .attr("width", this.ls_w)
                .attr("height", this.ls_h)
                .attr("class", function(d, i) { return gis_color(d); });

        this.legendtext = this.legend.append("text")
                .attr("x", 30)
                .attr("y", function(d, i) { return ((i + 1) * ls_h) + 24; })
                .text(function count(d, i) {
                    if (i == 0) {
                        return ">" + d3.format("s")(d).toString();
                    }
                    else {
                        return d3.format("s")(d).toString();
                    }
                });
        dojo.publish("on_mapready", {});
        if (gis_data && !this.initialized) this.on_gisdata();
    };

    function on_gisdata() {
        if (!gis_data) return;
        //var m = "client:dashboard:gis:usa:{'37059,356.93;12111,3638.77;23003,120000.44;26037,1093.47;34023,15510.36;35013,2357.17;27027,2416.38;48477,693.92;47157,8119.78;39105,29.95;2290,140000.22;23001,1783.90;49005,3980.74;53031,279.98;13299,7363.44;48345,119.99;46035,844.96;09009,11668.42;56001,2113.75;00000,18249.78;06105,11.51;20031,39.99;54087,161.99;28149,1179.84;54021,659.98;51051,39.99;30063,3017.93;13035,29.99;39039,49.00;01089,11618.76;45045,6018.58;05115,2982.38;26103,618.09;29007,1327.34;42075,732.68;06039,1128.90;37125,1129.98;36003,39.99;36069,1736.42;21021,56.68;22011,757.41;13233,124.97;17127,157.46;16005,1022.87;05049,59.99;56035,17.94;55045,19.90;01057,59.99;54055,71.99;17029,3848.93;22111,248.49;49039,1299.97;4027,90000.45'}";
        var mi = this.map_instance; if (!mi) return;
        var gc = this.gis_color; if (!gc) return;
        var mc = this.map_counties; if (!mc) return;
        var mj = d3.map(); if (!mj) return;
        if (!mi) return;
        var ar = gis_data.split("'")[1].split(";");

        for (idx = ar.length - 1; idx >= 0; idx--) {
            mi.set(ar[idx].split(",")[0], +ar[idx].split(",")[2]);
        };
        for (idx = ar.length - 1; idx >= 0; idx--) {
            mj.set(ar[idx].split(",")[0], +ar[idx].split(",")[3]);
        };

        this.gis_tip.html(function(d, i) {
            var reveuneT;
            var orderT;
            if (mi.get(d.properties.state) == undefined || mi.get(+d.properties.id) <= 0) {
                reveuneT = 0;
            }
            else {
                reveuneT = mi.get(d.properties.state);
            }
            if (mj.get(d.properties.state) == undefined || mj.get(+d.properties.id) <= 0) {
                orderT = 0;
            }
            else {
                orderT = mj.get(d.properties.state);
            }
            return "<b>State:</b>" + d.properties.name
                    + "<br>Orders:" + orderT
                    + "<br>Revenue:" + dojo.currency.format(reveuneT, { currency: "USD", places: 0 });
        });

        mc.attr("class", function(d) {
            if (mi.get(d.properties.state) == undefined || mi.get(d.properties.state) <= 0) {
                return "reset";
            } else {
                return gc(mi.get(d.properties.state));
            }
        });
        this.initialized = 1;
    };


    d3.select(self.frameElement).style("height", height + "px");


</script>
</body>
</html>
